<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thêm Truyện Mới - Web Đọc Truyện</title>
    <link rel="stylesheet" href="../css/styles.css" />
    <link rel="stylesheet" href="../css/admin.css" />
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <!-- Select2 CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
      .add-story-container {
        max-width: 800px;
        margin: 0 auto;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px #0001;
        padding: 32px;
      }
      .add-story-title {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 24px;
      }
    </style>
  </head>
  <body class="admin-page">
    <!-- Admin Sidebar -->
    <div class="admin-sidebar">
      <div class="sidebar-header">
        <h2>TruyệnHay Admin</h2>
      </div>
      <ul class="admin-menu">
        <li>
          <a href="index.html"
            ><i class="fas fa-tachometer-alt"></i> Bảng điều khiển</a
          >
        </li>
        <li class="active">
          <a href="stories.html"><i class="fas fa-book"></i> Quản lý truyện</a>
        </li>
        <li>
          <a href="chapters.html"
            ><i class="fas fa-file-alt"></i> Quản lý chương</a
          >
        </li>
        <li>
          <a href="users.html"
            ><i class="fas fa-users"></i> Quản lý người dùng</a
          >
        </li>
        <li>
          <a href="transactions.html"
            ><i class="fas fa-money-bill-wave"></i> Quản lý giao dịch</a
          >
        </li>
        <li>
          <a href="genres.html"><i class="fas fa-tags"></i> Quản lý thể loại</a>
        </li>
        <li>
          <a href="coin-packages.html"
            ><i class="fas fa-coins"></i> Quản lý gói xu</a
          >
        </li>
        <li class="sidebar-footer">
          <a href="../index.html"
            ><i class="fas fa-sign-out-alt"></i> Về trang chủ</a
          >
        </li>
      </ul>
    </div>
    <!-- Main Content -->
    <div class="admin-content">
      <div class="admin-header">
        <div class="admin-header-left">
          <h1 class="add-story-title">Thêm Truyện Mới</h1>
        </div>
        <div class="admin-header-right"></div>
      </div>
      <div class="add-story-container">
        <form id="storyForm">
          <input type="hidden" id="storyId" />
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="storyTitle" class="form-label"
                >Tên truyện <span class="text-danger">*</span></label
              >
              <input
                type="text"
                id="storyTitle"
                name="title"
                class="form-control"
                required
              />
            </div>
            <div class="col-md-6">
              <label for="storyAuthor" class="form-label"
                >Tác giả <span class="text-danger">*</span></label
              >
              <input
                type="text"
                id="storyAuthor"
                name="author"
                class="form-control"
                required
              />
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="storyStatus" class="form-label">Trạng thái</label>
              <select id="storyStatus" name="status" class="form-select">
                <option value="ongoing">Đang ra</option>
                <option value="completed">Hoàn thành</option>
                <option value="paused">Tạm ngưng</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="storyGenres" class="form-label"
                >Thể loại <span class="text-danger">*</span></label
              >
              <select
                id="storyGenres"
                name="genres[]"
                class="form-select"
                multiple="multiple"
                required
                style="width: 100%"
              >
                <option value="loading" disabled>Đang tải thể loại...</option>
              </select>
              <small class="form-text text-muted"
                >Có thể chọn nhiều thể loại</small
              >
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-12">
              <label class="form-label">Tùy chọn đặc biệt</label>
              <div class="d-flex gap-3">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="isHot"
                    name="isHot"
                  />
                  <label class="form-check-label" for="isHot">Truyện Hot</label>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="isNew"
                    name="isNew"
                  />
                  <label class="form-check-label" for="isNew">Truyện Mới</label>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="isFull"
                    name="isFull"
                  />
                  <label class="form-check-label" for="isFull"
                    >Truyện Full</label
                  >
                </div>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label for="storyDescription" class="form-label">Mô tả</label>
            <textarea
              id="storyDescription"
              name="description"
              class="form-control"
              rows="4"
            ></textarea>
          </div>
          <div class="mb-3">
            <label for="storyCover" class="form-label">Ảnh bìa</label>
            <input
              type="file"
              id="storyCover"
              name="cover"
              class="form-control"
              accept="image/*"
            />
            <div id="imagePreview" class="mt-2"></div>
          </div>
          <div class="d-flex justify-content-end gap-2">
            <a href="stories.html" class="btn btn-secondary">Quay lại</a>
            <button type="button" id="saveStoryBtn" class="btn btn-primary">
              Thêm truyện
            </button>
          </div>
        </form>
      </div>
    </div>
    <!-- Select2 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.full.min.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/admin/admin-common.js"></script>
    <script src="../js/admin/stories.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      $(document).ready(function () {
        $("#storyGenres").select2({
          placeholder: "Chọn thể loại",
          allowClear: true,
          width: "100%",
        });
      });

      // --- Bổ sung: Nếu có id trên URL, tự động load truyện và fill form ---
      document.addEventListener("DOMContentLoaded", async function () {
        const urlParams = new URLSearchParams(window.location.search);
        const storyId = urlParams.get("id");
        if (storyId) {
          // Đổi tiêu đề và nút
          document.querySelector(".add-story-title").textContent =
            "Chỉnh sửa truyện";
          document.getElementById("saveStoryBtn").textContent = "Lưu thay đổi";

          // Đợi genres load xong mới fill form
          await new Promise((resolve) => setTimeout(resolve, 500));

          try {
            const res = await fetch(`/admin/stories/${storyId}`, {
              headers: { Accept: "application/json" },
            });
            if (!res.ok) throw new Error("Không tìm thấy truyện");
            const data = await res.json();
            const story = data.data || data.story || data;
            if (!story) throw new Error("Không có dữ liệu truyện");
            // Fill form
            document.getElementById("storyId").value =
              story._id || story.id || "";
            document.getElementById("storyTitle").value = story.title || "";
            document.getElementById("storyAuthor").value = story.author || "";
            document.getElementById("storyStatus").value =
              story.status || "ongoing";
            document.getElementById("storyDescription").value =
              story.description || "";
            document.getElementById("isHot").checked = story.isHot || false;
            document.getElementById("isNew").checked = story.isNew || false;
            document.getElementById("isFull").checked =
              story.status === "completed";
            // Ảnh bìa
            if (story.coverImage) {
              document.getElementById(
                "imagePreview"
              ).innerHTML = `<img src="${story.coverImage}" alt="Ảnh bìa" class="img-fluid img-thumbnail" style="max-height: 200px;">`;
            }
            // Thể loại
            setTimeout(() => {
              const genresSelect = document.getElementById("storyGenres");
              if (genresSelect && story.genres) {
                const genreIds = story.genres.map((g) =>
                  typeof g === "object" ? g._id || g.id : g
                );
                $(genresSelect).val(genreIds).trigger("change");
              }
            }, 300);
          } catch (err) {
            alert("Không thể tải dữ liệu truyện: " + err.message);
          }
        }
      });
    </script>
  </body>
</html>
