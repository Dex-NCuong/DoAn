<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thêm Chương Mới - Web Đọc Truyện</title>
    <link rel="stylesheet" href="../css/styles.css" />
    <link rel="stylesheet" href="../css/admin.css" />
    <link rel="stylesheet" href="../css/chapter.css" />
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/summernote@0.8.20/dist/summernote-lite.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.20/dist/summernote-lite.min.js"></script>
    <style>
      /* Đảm bảo editor hiển thị đúng trong form */
      .document-editor {
        border: 1px solid #dfe4e6;
        border-radius: 4px;
      }

      .document-editor__toolbar {
        position: sticky;
        top: 0;
        background: #f7f7f7;
        border-bottom: 1px solid #dfe4e6;
        padding: 8px;
        z-index: 100;
      }

      .document-editor__editable-container {
        padding: 20px;
        background: #fff;
      }

      .document-editor__editable {
        min-height: 500px;
        padding: 20px;
        background: #fff;
      }

      /* Đảm bảo dropdown menu hiển thị đúng */
      .ck.ck-dropdown__panel {
        max-height: 300px;
        overflow-y: auto;
      }

      /* Tăng độ tương phản cho toolbar */
      .ck.ck-toolbar {
        background: #f0f0f0 !important;
        border: 1px solid #ddd !important;
      }

      .ck.ck-toolbar .ck-toolbar__items {
        flex-wrap: wrap !important;
      }

      /* Làm rõ các nút trong toolbar */
      .ck.ck-button {
        color: #333 !important;
      }

      .ck.ck-button:hover {
        background: #e3e3e3 !important;
      }

      .ck.ck-button.ck-on {
        background: #ddd !important;
        color: #000 !important;
      }
    </style>
  </head>
  <body class="admin-page">
    <!-- Admin Sidebar -->
    <div class="admin-sidebar">
      <div class="sidebar-header">
        <h2>TruyệnHay Admin</h2>
      </div>
      <ul class="admin-menu">
        <li>
          <a href="index.html"
            ><i class="fas fa-tachometer-alt"></i> Bảng điều khiển</a
          >
        </li>
        <li>
          <a href="stories.html"><i class="fas fa-book"></i> Quản lý truyện</a>
        </li>
        <li class="active">
          <a href="chapters.html"
            ><i class="fas fa-file-alt"></i> Quản lý chương</a
          >
        </li>
        <li>
          <a href="users.html"
            ><i class="fas fa-users"></i> Quản lý người dùng</a
          >
        </li>
        <li>
          <a href="transactions.html"
            ><i class="fas fa-money-bill-wave"></i> Quản lý giao dịch</a
          >
        </li>
        <li>
          <a href="genres.html"><i class="fas fa-tags"></i> Quản lý thể loại</a>
        </li>
        <li>
          <a href="coin-packages.html"
            ><i class="fas fa-coins"></i> Quản lý gói xu</a
          >
        </li>
        <li class="sidebar-footer">
          <a href="../index.html"
            ><i class="fas fa-sign-out-alt"></i> Về trang chủ</a
          >
        </li>
      </ul>
    </div>

    <!-- Main Content -->
    <div class="admin-content">
      <div class="admin-header">
        <div class="admin-header-left">
          <h1>Thêm Chương Mới</h1>
        </div>
        <div class="admin-header-right"></div>
      </div>

      <!-- Add Chapter Form -->
      <div class="add-chapter-wrapper">
        <div class="add-chapter-container">
          <form id="add-chapter-form" class="chapter-form">
            <div class="row mb-4">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="new-chapter-story" class="form-label"
                    >Truyện:</label
                  >
                  <select id="new-chapter-story" class="form-select" required>
                    <option value="">-- Chọn truyện --</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="new-chapter-title" class="form-label"
                    >Tiêu đề chương:</label
                  >
                  <input
                    type="text"
                    id="new-chapter-title"
                    class="form-control"
                    required
                    placeholder="Nhập tiêu đề chương..."
                  />
                </div>
              </div>
            </div>

            <div class="row mb-4">
              <div class="col-md-4">
                <div class="form-group">
                  <label for="new-chapter-number" class="form-label"
                    >Số chương:</label
                  >
                  <input
                    type="number"
                    id="new-chapter-number"
                    class="form-control"
                    min="1"
                    required
                  />
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label for="new-chapter-type" class="form-label"
                    >Loại chương:</label
                  >
                  <select id="new-chapter-type" class="form-select">
                    <option value="free">Miễn phí</option>
                    <option value="vip">VIP</option>
                  </select>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label for="new-chapter-price" class="form-label"
                    >Giá xu (nếu VIP):</label
                  >
                  <input
                    type="number"
                    id="new-chapter-price"
                    class="form-control"
                    min="0"
                    value="0"
                  />
                </div>
              </div>
            </div>

            <div class="chapter-content-section">
              <div class="form-group">
                <label for="new-chapter-content" class="form-label mb-3"
                  >Nội dung chương:</label
                >
                <textarea
                  id="new-chapter-content"
                  class="form-control chapter-content"
                  rows="20"
                  placeholder="Nhập hoặc dán nội dung chương ở đây..."
                ></textarea>
              </div>
            </div>

            <div class="form-actions mt-4">
              <button
                type="button"
                class="btn btn-secondary"
                onclick="history.back()"
              >
                Quay lại
              </button>
              <button type="submit" class="btn btn-primary">Lưu chương</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/admin/admin-common.js"></script>
    <script src="../js/admin/add-chapter.js"></script>
    <script>
      $(document).ready(function () {
        // Nút căn giữa ảnh
        var centerImageButton = function (context) {
          var ui = $.summernote.ui;
          var button = ui.button({
            contents: '<i class="fa fa-align-center"></i>',
            tooltip: "Căn giữa ảnh",
            click: function () {
              var $img = $(context.invoke("restoreTarget"));
              if ($img.length) {
                $img.css({
                  display: "block",
                  marginLeft: "auto",
                  marginRight: "auto",
                  float: "",
                });
              }
            },
          });
          return button.render();
        };
        // Nút đặt ảnh về 100%
        var imageSize100Button = function (context) {
          var ui = $.summernote.ui;
          var button = ui.button({
            contents: "100%",
            tooltip: "Đặt ảnh 100%",
            click: function () {
              var $img = $(context.invoke("restoreTarget"));
              if ($img.length) {
                $img.css({ width: "100%", height: "", maxWidth: "100%" });
              }
            },
          });
          return button.render();
        };
        // Nút đặt ảnh về 50%
        var imageSize50Button = function (context) {
          var ui = $.summernote.ui;
          var button = ui.button({
            contents: "50%",
            tooltip: "Đặt ảnh 50%",
            click: function () {
              var $img = $(context.invoke("restoreTarget"));
              if ($img.length) {
                $img.css({ width: "50%", height: "", maxWidth: "100%" });
              }
            },
          });
          return button.render();
        };
        // Nút đặt ảnh về 25%
        var imageSize25Button = function (context) {
          var ui = $.summernote.ui;
          var button = ui.button({
            contents: "25%",
            tooltip: "Đặt ảnh 25%",
            click: function () {
              var $img = $(context.invoke("restoreTarget"));
              if ($img.length) {
                $img.css({ width: "25%", height: "", maxWidth: "100%" });
              }
            },
          });
          return button.render();
        };
        // Nút đặt lại kích thước gốc
        var imageSizeOriginalButton = function (context) {
          var ui = $.summernote.ui;
          var button = ui.button({
            contents: '<i class="fa fa-star"></i>',
            tooltip: "Kích thước gốc",
            click: function () {
              var $img = $(context.invoke("restoreTarget"));
              if ($img.length) {
                $img.css({ width: "", height: "", maxWidth: "" });
              }
            },
          });
          return button.render();
        };
        // Nút reset style ảnh
        var imageResetButton = function (context) {
          var ui = $.summernote.ui;
          var button = ui.button({
            contents: '<i class="fa fa-history"></i>',
            tooltip: "Đặt lại ảnh",
            click: function () {
              var $img = $(context.invoke("restoreTarget"));
              if ($img.length) {
                $img.removeAttr("style");
              }
            },
          });
          return button.render();
        };

        // Initialize Summernote with error handling
        try {
          const editorContainer = $("#new-chapter-content");
          if (editorContainer.length) {
            editorContainer.summernote({
              placeholder: "Nhập hoặc dán nội dung chương ở đây...",
              tabsize: 2,
              height: 400,
              toolbar: [
                ["style", ["bold", "italic", "underline", "clear"]],
                ["para", ["ul", "ol", "paragraph"]],
                ["insert", ["link", "picture"]],
                ["view", ["undo", "redo", "codeview"]],
              ],
              popover: {
                image: [
                  [
                    "imagesize",
                    [
                      "imageSize100",
                      "imageSize50",
                      "imageSize25",
                      "imageSizeOriginal",
                      "imageReset",
                    ],
                  ],
                  ["float", ["floatLeft", "floatRight", "centerImage"]],
                  ["remove", ["removeMedia"]],
                ],
              },
              buttons: {
                centerImage: centerImageButton,
                imageSize100: imageSize100Button,
                imageSize50: imageSize50Button,
                imageSize25: imageSize25Button,
                imageSizeOriginal: imageSizeOriginalButton,
                imageReset: imageResetButton,
              },
              callbacks: {
                onInit: function () {
                  console.log("Summernote initialized successfully");
                },
                onError: function (error) {
                  console.error("Summernote error:", error);
                },
                onPaste: function (e) {
                  e.preventDefault();
                  var clipboardData = (e.originalEvent || e).clipboardData;
                  var text = clipboardData.getData("text/plain");
                  var html = clipboardData.getData("text/html");
                  if (html) {
                    // Loại bỏ background-color trong style inline
                    html = html.replace(/background-color\s*:[^;\"]+;?/gi, "");
                    // Loại bỏ thẻ span/style có background-color
                    html = html.replace(
                      /(<span[^>]*style=\"[^"]*)background-color\s*:[^;\"]+;?([^"]*\"[^>]*>)/gi,
                      "$1$2"
                    );
                    // Chèn lại nội dung đã làm sạch
                    document.execCommand("insertHTML", false, html);
                  } else {
                    document.execCommand("insertText", false, text);
                  }
                },
              },
            });
          } else {
            console.error("Editor container not found: #new-chapter-content");
          }
        } catch (error) {
          console.error("Error initializing Summernote:", error);
        }
      });
    </script>
  </body>
</html>
